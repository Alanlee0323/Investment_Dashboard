
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>投資組合儀表板</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>我的投資組合儀表板</h1>

        {# 如果沒有資料，顯示上傳表單 #}
        {% if not holdings %}
        <div class="upload-form-container">
            <h2>請上傳您的投資報表</h2>
            <p>您的檔案僅會被用於當前的瀏覽階段，不會被儲存到任何地方。</p>
            <form action="{{ url_for('upload_files') }}" method="post" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="us_stock_file">美股庫存報表 (CSV 格式)</label>
                    <input type="file" id="us_stock_file" name="us_stock_file" accept=".csv" required>
                </div>
                <div class="form-group">
                    <label for="tw_stock_file">台股庫存報表 (XLSX 格式)</label>
                    <input type="file" id="tw_stock_file" name="tw_stock_file" accept=".xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" required>
                </div>
                <button type="submit" class="button-primary">產生儀表板</button>
            </form>
        </div>

        {# 如果有資料，顯示整個儀表板 #}
        {% else %}
        <div class="summary-box">
            <div class="summary-item">
                <h2>總市值 (TWD)</h2>
                <p>NT$ {{ summary.total_market_value }}</p>
            </div>
            <div class="summary-item">
                <h2>總損益 (TWD)</h2>
                <p class="{{ 'positive' if summary.total_profit_loss|replace(',', '')|float >= 0 else 'negative' }}">
                    NT$ {{ summary.total_profit_loss }}
                </p>
            </div>
            <div class="summary-item">
                <h2>總月現金流</h2>
                <p>{{ summary.monthly_cash_flow }}</p>
            </div>
            <div class="summary-item">
                <h2>美元匯率</h2>
                <p>{{ summary.usd_rate }}</p>
            </div>
        </div>

        <div class="chart-container">
            <h2>多市場資產配置</h2>
            <canvas id="assetAllocationChart"></canvas>
        </div>

        <div class="sub-charts-container">
            <div class="chart-container">
                <h2>美股持股佔比</h2>
                <canvas id="usAllocationChart"></canvas>
            </div>
            <div class="chart-container">
                <h2>台股高股息佔比</h2>
                <canvas id="twAllocationChart"></canvas>
            </div>
        </div>

        <div class="table-header">
            <h2>美股持股明細</h2>
            <a href="{{ url_for('reset_session') }}" class="button-secondary">重新上傳</a>
        </div>
        <table>
            <thead>
                <tr>
                    <th>股號</th>
                    <th>產業別</th>
                    <th>目前持股</th>
                    <th>買入均價 (USD)</th>
                    <th>目前股價 (USD)</th>
                    <th class="sortable {% if sort_by == 'market_value_twd' %}sorted-by{% endif %}">
                        <a href="{{ url_for('dashboard', sort_by='market_value_twd', sort_order='desc' if sort_by != 'market_value_twd' else 'asc' if sort_order == 'desc' else 'desc') }}">
                            市值 (TWD)
                            {% if sort_by == 'market_value_twd' %}<span class="sort-indicator">{{ '▼' if sort_order == 'desc' else '▲' }}</span>{% endif %}
                        </a>
                    </th>
                    <th class="sortable {% if sort_by == 'position_percentage' %}sorted-by{% endif %}">
                        <a href="{{ url_for('dashboard', sort_by='position_percentage', sort_order='desc' if sort_by != 'position_percentage' else 'asc' if sort_order == 'desc' else 'desc') }}">
                            部位占比
                            {% if sort_by == 'position_percentage' %}<span class="sort-indicator">{{ '▼' if sort_order == 'desc' else '▲' }}</span>{% endif %}
                        </a>
                    </th>
                    <th class="sortable {% if sort_by == 'profit_loss_twd' %}sorted-by{% endif %}">
                        <a href="{{ url_for('dashboard', sort_by='profit_loss_twd', sort_order='desc' if sort_by != 'profit_loss_twd' else 'asc' if sort_order == 'desc' else 'desc') }}">
                            淨利潤 (TWD)
                            {% if sort_by == 'profit_loss_twd' %}<span class="sort-indicator">{{ '▼' if sort_order == 'desc' else '▲' }}</span>{% endif %}
                        </a>
                    </th>
                    <th class="sortable {% if sort_by == 'roi' %}sorted-by{% endif %}">
                        <a href="{{ url_for('dashboard', sort_by='roi', sort_order='desc' if sort_by != 'roi' else 'asc' if sort_order == 'desc' else 'desc') }}">
                            投報率
                            {% if sort_by == 'roi' %}<span class="sort-indicator">{{ '▼' if sort_order == 'desc' else '▲' }}</span>{% endif %}
                        </a>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for item in holdings %}
                <tr>
                    <td>{{ item.ticker }}</td>
                    <td>{{ item.sector }}</td>
                    <td>{{ item.shares }}</td>
                    <td>$ {{ item.avg_cost }}</td>
                    <td>$ {{ item.current_price }}</td>
                    <td>NT$ {{ item.market_value_twd }}</td>
                    <td>{{ item.position_percentage }}</td>
                    <td class="{{ 'positive' if item.profit_loss_twd|replace(',', '')|float >= 0 else 'negative' }}">
                        NT$ {{ item.profit_loss_twd }}
                    </td>
                    <td class="{{ 'positive' if item.roi|replace('%', '')|float >= 0 else 'negative' }}">
                        {{ item.roi }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h2>台股高股息持股明細</h2>
        <table>
            <thead>
                <tr>
                    <th>代號</th>
                    <th>目前股價</th>
                    <th>目前庫存</th>
                    <th>市值 (TWD)</th>
                    <th>最近現金股利</th>
                    <th>年配息次數</th>
                    <th>預估月現金流(TWD)</th>
                </tr>
            </thead>
            <tbody>
                {% for item in tw_holdings %}
                <tr>
                    <td>{{ item.ticker }}</td>
                    <td>{{ item.price }}</td>
                    <td>{{ item.shares }}</td>
                    <td>NT$ {{ item.market_value }}</td>
                    <td>{{ item.last_dividend }}</td>
                    <td>{{ item.payouts_per_year }}</td>
                    <td>NT$ {{ item.monthly_income }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        // 只有在 holdings 資料存在時才執行圖表腳本
        {% if holdings %}
        // 1. Get all data from Flask backend
        const assetData = {{ asset_allocation | tojson }};
        const usAllocationData = {{ us_stock_allocation | tojson }};
        const twAllocationData = {{ tw_stock_allocation | tojson }};

        // 2. Register the datalabels plugin
        Chart.register(ChartDataLabels);

        // 3. Helper function to generate charts
        const generatePieChart = (elementId, chartData, chartTitle) => {
            const ctx = document.getElementById(elementId).getContext('2d');
            if (!chartData || !chartData.values || chartData.values.length === 0) {
                ctx.font = "16px Arial";
                ctx.textAlign = "center";
                ctx.fillText("沒有可顯示的資料", ctx.canvas.width / 2, ctx.canvas.height / 2);
                return null;
            }
            return new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: '資產市值 (TWD)',
                        data: chartData.values,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: chartTitle
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    let value = context.raw || 0;
                                    let total = context.chart.getDatasetMeta(0).total;
                                    let percentage = (value / total * 100).toFixed(2) + '%';
                                    return `${label}: ${Math.round(value).toLocaleString()} TWD (${percentage})`;
                                }
                            }
                        },
                        datalabels: {
                            formatter: (value, ctx) => {
                                return ctx.chart.data.labels[ctx.dataIndex]; // Show ticker symbol
                            },
                            color: '#fff',
                            backgroundColor: 'rgba(0, 0, 0, 0.5)',
                            borderRadius: 4,
                            font: {
                                weight: 'bold'
                            }
                        }
                    }
                }
            });
        };

        // 4. Generate the three charts
        const mainAllocationChart = generatePieChart('assetAllocationChart', assetData, '多市場資產配置');
        if (mainAllocationChart) {
            mainAllocationChart.data.datasets[0].backgroundColor = ['rgba(54, 162, 235, 0.8)', 'rgba(255, 99, 132, 0.8)'];
            mainAllocationChart.data.datasets[0].borderColor = ['rgba(54, 162, 235, 1)', 'rgba(255, 99, 132, 1)'];
            mainAllocationChart.options.plugins.legend.display = true;
            mainAllocationChart.options.plugins.datalabels.display = false; // Hide labels for the main chart
            mainAllocationChart.update();
        }

        generatePieChart('usAllocationChart', usAllocationData, '美股持股佔比');
        generatePieChart('twAllocationChart', twAllocationData, '台股高股息佔比');
        {% endif %}
    </script>
    {% endif %}
</body>
</html>
